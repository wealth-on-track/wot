generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ApiRequestLog {
  id         String   @id @default(cuid())
  provider   String
  endpoint   String
  params     String
  status     String
  statusCode Int?
  duration   Int?
  error      String?
  userId     String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([provider, status])
}

model ApiUsage {
  id           String   @id @default(cuid())
  provider     String
  dateKey      String
  successCount Int      @default(0)
  errorCount   Int      @default(0)
  lastUpdated  DateTime @updatedAt

  @@unique([provider, dateKey])
}

model Asset {
  id             String        @id @default(cuid())
  portfolioId    String
  category       AssetCategory @default(US_MARKETS)
  type           String
  symbol         String
  name           String?
  originalName   String?
  quantity       Float
  buyPrice       Float
  currency       String
  exchange       String
  sector         String
  country        String
  customSector   String?
  customCountry  String?
  customCurrency String?
  customType     String?
  customExchange String?
  platform       String?
  logoUrl        String?
  sortOrder      Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  customGroup    String?
  isin           String?
  metadata       Json?
  Portfolio      Portfolio     @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, isin, customGroup])
  @@index([category])
  @@index([portfolioId, createdAt])
  @@index([portfolioId, sortOrder])
  @@index([symbol])
}

model AssetPriceHistory {
  id        String   @id @default(cuid())
  symbol    String
  price     Float
  currency  String
  date      DateTime
  createdAt DateTime @default(now())

  @@unique([symbol, date])
  @@index([symbol, date])
}

model AssetTransaction {
  id               String    @id @default(cuid())
  portfolioId      String
  symbol           String
  name             String?
  type             String
  quantity         Float
  price            Float
  currency         String
  fee              Float     @default(0)
  date             DateTime
  exchange         String?
  platform         String?
  externalId       String?
  realizedPnl      Float?
  snapshotAvgCost  Float?
  snapshotQuantity Float?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  customGroup      String?
  Portfolio        Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, externalId])
  @@index([portfolioId, date])
  @@index([portfolioId, symbol])
  @@index([portfolioId, type])
}

model BenchmarkCache {
  id        String   @id @default(cuid())
  symbol    String
  period    String
  data      Json
  updatedAt DateTime @updatedAt

  @@unique([symbol, period])
}

model BenchmarkPrice {
  id        String   @id @default(cuid())
  symbol    String
  date      DateTime
  price     Float
  createdAt DateTime @default(now())

  @@unique([symbol, date])
  @@index([symbol, date])
}

model ExchangeRate {
  currency  String   @id
  rate      Float
  updatedAt DateTime @updatedAt
}

model Goal {
  id            String    @id @default(cuid())
  portfolioId   String
  name          String
  type          String?   @default("USER")
  targetAmount  Float
  currentAmount Float     @default(0)
  currency      String    @default("EUR")
  deadline      DateTime?
  isCompleted   Boolean   @default(false)
  icon          String?   @default("target")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
}

model Portfolio {
  id                String              @id @default(cuid())
  userId            String              @unique
  isPublic          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  Asset             Asset[]
  AssetTransaction  AssetTransaction[]
  Goal              Goal[]
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  PortfolioSnapshot PortfolioSnapshot[]
}

model PortfolioSnapshot {
  id          String    @id @default(cuid())
  portfolioId String
  date        DateTime
  totalValue  Float
  createdAt   DateTime  @default(now())
  Portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, date])
}

model PriceCache {
  symbol              String    @id
  previousClose       Float
  currency            String
  sector              String?
  country             String?
  tradeTime           DateTime?
  source              String?
  lastRequestedBy     String?
  updatedAt           DateTime  @updatedAt
  actualPreviousClose Float?

  @@index([updatedAt])
  @@index([source])
}

model SystemActivityLog {
  id           String   @id @default(cuid())
  activityType String
  action       String
  userId       String?
  username     String?
  targetType   String?
  targetId     String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  duration     Int?
  status       String   @default("SUCCESS")
  errorMessage String?
  createdAt    DateTime @default(now())

  @@index([activityType, action])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([username, createdAt])
}

model User {
  id          String     @id @default(cuid())
  username    String     @unique
  email       String     @unique
  password    String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  preferences Json?
  role        UserRole   @default(USER)
  Portfolio   Portfolio?
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum AssetCategory {
  BIST
  TEFAS
  US_MARKETS
  EU_MARKETS
  CRYPTO
  COMMODITIES
  FX
  CASH
  BENCHMARK
  BES
}
